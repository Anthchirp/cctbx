from __future__ import absolute_import, division, print_function
import os
from cctbx.array_family import flex
from iotbx.cli_parser import run_program
import libtbx
from libtbx.utils import null_out
from libtbx.test_utils import approx_equal
from iotbx.data_manager import DataManager
from cctbx.programs import qscore




expected_results = {
  17:[
    0.3421921625599796,
0.23059586409823973,
0.5270018776968665,
0.29184116446707,
0.2973812006489643,
0.07600997821758661,
0.33045716863866426,
0.03962350210737266,
0.45794512843877005,
0.35465168874249403,
0.23226261428093095,
0.26433144001016096,
0.41278635270991104,
0.6186540306246111,
0.3770973684892207,
0.1254397336440012,
0.5285370113101394,
0.2223610365635392,
0.24309534172227623,
0.30352501019319705,
0.2752690339591535,
0.4899237828881729,
0.47240975385758843,
0.22025163500887476,
0.5397425995575168,
0.26138971843050957,
0.1846157694745772,
0.45832140303149244,
0.3199925993370375,
0.35148314291468097,
0.30805876853197545,
0.2348747178532036,
0.40538545573721857,
0.35931982891529424,
0.06674246110537026,
0.08865944371905632,
0.46383366221789635,
0.2414768194261802,
0.48285460422290516,
0.347877304598477,
0.29203014359638124,
0.1947260717344384,
0.3991802715787289,
0.15842934668592273,
0.280357208712987,
0.021717502283329426,
0.4062439964555134,
0.3865031622747038,
0.29816347111472813,
0.45863553488308767,
0.3973819008836693,
0.531306284812025,
0.07867336339275807,
0.25396729661621414,
0.5707587513791409,
0.2600181342944659,
0.21478114239293503,
0.18550113903271073,
0.2997586158550855,
0.44065895599883254,
0.5339912733146549,
0.5059403589930165,
0.399563388207582,
0.31353965867608585,
0.40706293922680536,
0.40852998551402225,
0.37818395249405246,
0.34189236056721284,
0.520108250944137,
0.29432165478083183,
0.34554241140959957,
0.3809737558101816,
0.33047852491034596,
0.12000723357018166,
0.28516860178263526,
0.1304167083889345,
0.3702251144186975,
0.1306375003350293,
0.2525755342807049,
0.305846980315952,
0.36304984160901194,
0.26842234134086995,
0.31851634422367264,
0.11418522944583082,
0.6152548226050001,
0.4291161298297077,
0.10135045960919627,
0.43097837719824467,
0.3569904356893862,
0.3807958467081636,
0.048417434326699954,
0.15985263511257164,
0.5031089728058448,
0.33412590730425046,
0.2440388804247266,
0.22092929565192077,
0.34998096643341287,
0.5328979368545581,
0.4266904867364755,
0.26936514659137617,
0.3358724276862323,
0.14700048638497365,
0.3466519839231303,
0.3589201427103675,
0.3032979999041832,
0.46538655038051413,
0.3466157906620784,
0.24854267539811445,
0.4673383636231253,
0.49684501909476203,
0.14656288530085,
0.2060356161083599,
0.37147775553927004,
0.10325116448725478,
0.3298831493141937,
0.06128012250142477,
0.31965867165876083,
0.20571755422175803,
0.24666581378509295,
0.30188192740566117,
0.44059320534165436,
0.12535259204451776,
0.5391480678714957,
0.3146649234896872,
0.2984529944378834,
0.47059387025463373,
0.33688498405806233,
0.45724566460236,
-0.0847094806977648,
0.45241765479611734,
0.6024926988514311,
0.39043112440534494,
0.29212336908130637,
0.23521496698092792,
0.3331502225292009,
0.4710973854203711,
0.3930399946681371,
0.22618357696966504,
0.36777652710753406,
0.0687204125428958,
0.21794240968140147,
0.4585816225505588,
0.3189379047384071,
0.39631545999706735,
0.33782657195371435,
0.23053542900402393,
0.44634381476198975,
0.378636545735303,
0.0540847735219687,
0.15763453359404314,
0.3720433946019659,
0.2243999801330215,
0.3919840059559488,
0.24155293236144296,
0.5501860352383139,
0.31499601370777963,
0.3898073419940384,
0.25243082713588016,
0.4264068645720301,
0.06425344489908891,
0.44199112723007916,
0.36807522242257723,
0.29785713399865804,
0.412183321562423,
0.33525906932911176,
0.43397598115931846,
-0.010103891048515189,
0.2861456512828132,
0.5159897032252302,
0.3698059640541782,
0.28655590366719214,
0.25513393415337626,
0.2645690349170997,
0.5774885444935143,
0.5722935335150611,
0.12402945863077025,
0.3996273866908372,
0.24242658053677701,
0.32847927480603223,
0.4094780969465886,
0.4156053867514524,
0.17966699996528257,
0.40722902738054584,
0.12689775003918397,
0.371164181132422,
0.3767642054751001,
0.13130550470731653,
0.2581368857773402,
0.4295248268094051,
0.1594754057037172,
0.4822546259691846,
0.26862708250268674,
0.2053994164606709,
0.3314561119080312,
0.3901557321280329,
0.10356267623652139,
0.4893119933324595,
0.06970010217164949,
0.4341832340257733,
0.24300158997333163,
0.40342983455052717,
0.4875152102559497,
0.3611438908961756,
0.43315692556809254,
0.13005314649579647,
0.2789621268926412,
0.5797695620511155,
0.16073844912362031,
0.3189555777730557,
0.25307250722381414,
0.3337698438034294,
0.42692690233657604,
0.39577778624593446,
0.09985873598652467,
0.4519414307186756,
0.2722216910938107,
0.372440061007927,
0.372938237995561,
0.3373188155569413,
0.3077586817882031,
0.3268356422133767,
0.2637935136435236,
0.5124761116179708,
0.45120271947016605,
0.04645127186504295,
0.12464514753785585,
0.4076631108219313,
0.14149061521974549,
0.48019853552270136,
0.3302360313272201,
0.19387184572104918,
0.1276839312082207,
0.16838227799666874,
0.15212252134889084,
0.3938618155397946,
0.007238091652426953,
0.47956784581125006,
0.3628745036188133,
0.15933311523276858,
0.3450436068676078,
0.44003803751547854,
0.4790697870967329,
-0.20012992747200145,
0.22038229028354375,
0.4977640896498761,
0.20051572280775803,
0.37450575803439906,
0.24129734365789224,
0.30395715749502616,
0.5091826977961296,
0.43975091833718905,
0.234910477914851,
0.3763909822880909,
0.12134224515408576,
0.1469207447824904,
0.361680966789992,
0.3224493281226169,
0.1786168704708826,
0.3792230579360604,
0.15281162374642446,
0.42911335989536653,
0.31476367357186996,
0.07673757804961866,
0.10689006194487724,
0.4348292707713999,
0.18393677778574968,
  ],
    42:[
  0.04374859159228914,
  0.7014683292236671,
  0.702452905364866,
  0.7021948503391319,
  0.6321784075459557,
  0.49343050019989493,
  0.2387960398985455,
  0.16175122257257904,
  0.5951430522174325,
  0.7298902031066814,
  0.5532188675136824,
  0.7163124107885536,
  0.20712423014887388,
  0.25430831361146483,
  0.6549198534001504,
  0.7354481865202372,
  0.6662233425951913,
  0.7791061242902525,
  0.702971884514788,
  0.7701247147434058,
  0.7604352888270121,
  0.43373125301322574,
  0.592195693113768,
  0.6364893889382377,
  0.5338124993715777,
  0.8629489169692224,
  0.8309699855651322,
  0.8259201064688118,
  0.6416438069201235,
  0.47825154553942534,
  0.4550092060659318,
  0.7141126193559746,
  0.361378093066521,
  0.5170106846191803,
  0.5707500631718254,
  0.2992092767633682,
  0.5245848435807441,
  0.5457993561949297,
  0.43804435104199724,
  0.6965206562313486,
  0.8337428248309631,
  0.5605077031654175,
  0.6540968584763245,
  0.5637569078486285,
  0.5425493265063142,
  0.7905467036720909,
  0.8127777974919012,
  0.16915735889528427,
  0.8851526077212654,
  0.7229453458130224,
  0.6297422798191332,
  0.5501958845022322,
  0.36465666366132,
  0.31652279968342384,
  0.3922520165718135,
  0.644278729536953,
  0.5976556071675406,
  0.4209522494216284,
  0.8009479990116065,
  0.6466622101616207,
  0.5943185266914189,
  0.6137118595285456,
  0.5007963438613854,
  0.8392920445753075,
  0.720763302874267,
  0.8557279503911867,
  0.666713487421232,
  0.8063221960473734,
  0.8505047278069652,
  0.8497427761241569,
  0.803346479118527,
  0.8499754939112326,
  0.31486843957067545,
  0.5200046832164775,
  0.37186717909606204,
  0.6257089207620644,
  0.5829209564081711,
  0.4418711637191809,
  0.8382691191598867,
  0.3985977869183781,
  0.6716185017722498,
  0.4282676780478786,
  0.4769409624386573,
  0.5910446920430065,
  0.8944305471390882,
  0.8928567384381616,
  0.7827931482685355,
  0.6583803668742215,
  0.5991078586481865,
  0.08023769884309902,
  0.6681897301421666,
  0.37209308303777267,
  0.6415923372742239,
  0.4426268000273496,
  0.8688990816217295,
  0.8070367895141034,
  0.8720127649194883,
  0.8203465022935613,
  0.8338592104583938,
  0.6990620518701595,
  0.2149555598988231,
  0.7567926316813701,
  0.8575551185788508,
  0.6933730350449754,
  0.9161219623118465,
  0.732624707051576,
  0.7555994039397524,
  0.5442291068799832,
  0.4627745063207215,
  0.7993664076349526,
  0.5256150479791528,
  0.6760701859645473,
  0.1302511186971115,
  0.7937133262639481,
  0.5220560401977098,
  0.28486982673453465,
  0.8325957396927982,
  0.8513773917569079,
  0.7475582394501862,
  0.8048612849474618,
  0.8214530862558614,
  0.8265812540190871,
  0.7242004339085576,
  0.8846853466892513,
  0.819423901100646,
  0.8313477848815514,
  0.5755446895056169,
  0.2546135793925592,
  0.5574703129705603,
  0.7300843901002169,
  0.5305151067732694,
  0.37122485649150677,
  0.8986747212742561,
  0.8380225816078332,
  0.7614209371152203,
  0.8960858704306193,
  0.7226287919159747,
  0.37728834622953006,
  0.21982393465181072,
  0.5455923669432795,
  0.6875281916354992,
  0.6560338112643748,
  0.7666954073180295,
  0.5964728319202803,
  0.8241982508051366,
  0.7981306054065668,
  0.8648202347360532,
  0.6202773580633816,
  0.40183146013098137,
  0.863659879304468,
  0.7328936642623606,
  0.43331966960473806,
  0.41051665674688637,
  0.3732321485324986,
  0.35704325729788094,
  0.33229209164428214,
  0.6168027054172801,
  0.6693757063241048,
  0.7826022797198974,
  0.5377086752347333,
  0.6730535064545592
  ],
  48: [
    0.5968541254772408,
0.5888149798397792,
0.315582500635734,
0.687079314914942,
-0.10788849213050972,
0.16254718641158727,
0.32455597581368123,
0.5302638476888132,
0.403992922141881,
0.6100358301708605,
0.5771768770057722,
0.2792661235629232,
0.2575949934159178,
0.6043836583958772,
0.7708730081576577,
0.6242504407090721,
0.13591271842406735,
0.18614841272819024,
-0.2628077298805197,
0.22025502165116118,
0.7091768516167763,
0.40239405704252396,
0.09949923664253973,
-0.054100560826983536,
0.21038809613088602,
0.007996193327384046,
0.6357088374844898,
0.258324242452466,
0.6917422678350181,
0.6857337642645633,
0.13084883287439783,
0.11834600629053386,
0.11256061932813789,
-0.32197959142088056,
0.1964277228764244,
0.5263412467056378,
0.47750577744670736,
0.6273411730359443,
0.5644985300402862,
-0.04914315380458464,
0.50787821609155,
0.6796080766675747,
0.49186053449280276,
0.7509837193151416,
0.4890882429801768,
0.10679031788648738,
0.40916823804687474,
0.788255742665104,
0.6570069433758265,
-0.19528178901870677,
-0.39998361609636585,
-0.5779325051441814,
0.6451869255926912,
0.5718358631709289,
0.3271255576435047,
0.5473709345665331,
0.6434335071057217,
0.4524362607690744,
0.6898807824065822,
0.7072495487992003,
0.6194096112060017,
-0.16830340496094134,
-0.4170271322831438,
-0.4642359202007596,
-0.4178461988711234,
0.6073341350813557,
0.5855734753991133,
0.8564952874666714,
0.6839532113518676,
0.5000213127939919,
-0.08326968807387838,
0.3570602870558649,
0.7018663463617603,
0.711969366411144,
0.44508111920540083,
0.5473132202073291,
0.4655274120927994,
0.7078374526458721,
0.17372169440403212,
-0.2522585714614016,
0.4648877781222761,
0.7597726350278259,
0.6707870646835342,
0.6573007782788086,
0.5198339575453219,
-0.0006526550069698477,
0.6072461380958942,
0.4214311340917669,
0.7173940904184968,
0.35733529642917017,
0.5589328732056613,
0.612336593479406,
0.6507700208799166,
0.25559454694029293,
0.44820830149665475,
0.7185191357007285,
0.5060258719916453,
0.5497397450602441,
0.5622895985717057,
0.5011199096743087,
0.1708925623515588,
-0.22131743662693917,
0.24501870130290582,
0.5196556754058135,
0.6172331426177281,
0.7029724816347478,
-0.025298909940450143,
0.36765131991932465,
0.2627628940499585,
0.6321682268748771,
-0.0500688433871909,
0.5763335415597144,
0.008612564030688004,
0.4472234144081752,
0.5929092758866635,
0.6843005300904107,
0.6651767633174818,
0.26333429778606227,
0.6414457509892533,
0.14438088419608539,
-0.21222131040832543,
0.10109932103828434,
0.34494471024693685,
0.5990874755868693,
0.7035932607975525,
0.4857858052204092,
0.4281832690795328,
0.2891807006509428,
0.22222323149421325,
0.203906427947274,
0.04671623310290915,
0.44848477802023157,
0.44684211728874007,
0.5645615585513909,
0.6342758281949152,
0.7489086658409955,
0.589070738843178,
0.41800198826016766,
0.4961210628234994,
-0.12984928751527708,
0.39110688153345324,
0.4928519249525499,
0.45581559545936545,
0.21425438653612414,
0.407549256302758,
-0.15035212940105575,
0.07036429249131188,
0.6488945090989772,
0.4946267386677905,
0.6382812819654359,
0.23775216404460772,
0.3055450860933104,
-0.16833165794875501,
-0.19048152061339418,
0.5553859609305851,
0.5406222276872222,
0.6415299499364683,
0.5487751251087766,
-0.09145281911606847,
0.28984243303281065,
0.009656212224640586,
0.1494707876965392,
0.11035761336516262,
0.5228293409179153,
0.22983894819798084,
0.4718316173428129,
0.44675298345251324,
0.6110538799666169,
0.40431875240561327,
0.46617059636437935,
0.45627276687090956,
-0.117947116698063,
0.4116000349271482,
0.5765557749775085,
0.2544777230831843,
0.4723904664490961,
0.024926912888517457,
0.5621786040077159,
0.6353312649614798,
-0.11651261586048801,
0.5633206031940512,
0.38602830801407023,
0.3703387686372386,
0.3144119800821697,
0.6892262947019678,
0.3760829781443364,
0.07418780367285109,
-0.19462135663672434,
0.4108928059365392,
0.29895474397513155,
0.6352052484435172,
0.2737730076758392,
0.1744028531150664,
0.10210585799412926,
0.3275183577296833,
-0.30303731977501597,
-0.24431571115581802,
0.7950029444847503,
0.3796560948926144,
0.5818371159456599,
0.4491548136066217,
-0.04931907230118858,
0.37017358917348503,
0.023401235075432583,
-0.09782988358799102,
0.63977831753492,
0.4321582398644358,
0.25078377961765774,
0.3469515045045513,
0.40989287767077875,
0.4376901052054188,
0.09475319685420992,
0.05742918560522124,
-0.46513487300102824,
-0.11594752857285522,
0.12854571044295462,
0.36297737921070805,
0.7694305255605903,
0.6152924317603523,
0.41393102341071225,
0.5477717598392893,
-0.2402803578626161,
0.4923987790733689,
0.24427080665726864,
0.5527035011741326,
0.520481852292403,
0.2545693380532749,
0.2943667973934887,
0.13894357009748437,
0.7620957496844697,
0.6147574799490112,
0.7580367523339745,
0.5457950033094567,
0.7178761945864589,
0.6757214005391818,
0.4788983409036063,
-0.0303463202660314,
0.6900029820032803,
0.5025196729969039,
0.602699059074302,
0.6107175777294718,
0.6514091338122153,
0.2821497089278383,
0.24515795566596624,
0.548841907952178,
0.5182059748859397,
0.788365623661261,
0.5841782769142585,
0.31236692438409164,
0.45591686200983655,
0.6797742941938839,
  ]
}
# make flex arrays
expected_results = {key:flex.double(val) for key,val in list(expected_results.items())}

def exercise(test_name):
  pdb_file = libtbx.env.find_in_repositories(
    relative_path=f"phenix_regression/real_space_refine/data/tst_{test_name}.pdb",
    test=os.path.isfile)

  map_file = libtbx.env.find_in_repositories(
    relative_path=f"phenix_regression/real_space_refine/data/tst_{test_name}.ccp4",
    test=os.path.isfile)

  result = run_program(
    program_class=qscore.Program,
    args = [pdb_file,map_file,"probe_allocation_method=progressive"],
    logger=null_out(),
  )

  
  try:
    expected_result = expected_results[test_name]
    assert approx_equal(expected_result, result.qscore,eps=1.e-2)
  except:
    for val in result.qscore:
      print(str(val)+",")
    raise

if (__name__ == "__main__"):
  """
  Test random files to verify basic functionality remains unchanged
  Data from phenix_regression/real_space_refine/data
  """
  for test_name in [17,42,48]:
    exercise(test_name)
  print("OK")
